# API 错误码说明

本文档详细说明了 API 接口中使用的所有错误码及其含义。

---

## 错误码总览

| 错误码 | HTTP 状态码 | 含义 | 相关接口 |
|---------|-------------|------|----------|
| 0 | 200 | 成功 | 所有接口 |
| 400 | 400 | 请求参数错误 | 部分接口 |
| 401 | 401 | 未认证 / Token 过期 | 部分接口 |
| 403 | 403 | 资源不存在 | 部分接口 |
| 404 | 404 | 资源已存在 | 注册接口 |
| 409 | 409 | 资源已存在 | 注册接口 |
| 422 | 422 | 验证失败 | 验证码接口 |
| 429 | 429 | 请求过多（速率限制） | 部分接口 |
| 500 | 500 | 服务器内部错误 | 所有接口 |

---

## 详细说明

### 0 - 成功

表示请求处理成功，返回期望的数据。

```json
{
  "code": 0,
  "message": "操作成功",
  "data": { ... }
}
```

### 400 - 请求参数错误

请求参数不符合预期格式或验证规则。

**常见原因：**
- 缺少必填参数
- 参数类型错误
- 参数值超出允许范围
- JSON 格式错误

**示例：**
```json
// 缺少参数
{
  "code": 400,
  "message": "缺少必填参数: username",
  "detail": "The 'username' field is required"
}

// 参数验证失败
{
  "code": 400,
  "message": "用户名格式不正确",
  "detail": "Username must contain only letters, numbers, underscores and hyphens"
}
```

### 401 - 未认证

访问需要认证的接口时，未提供有效的凭证。

**常见原因：**
- 未携带 Authorization 请求头
- Access Token 已过期
- Refresh Token 已过期或被撤销
- Token 格式错误

**示例：**
```json
{
  "code": 401,
  "message": "未认证，请重新登录",
  "detail": "Invalid or expired token"
}
```

### 403 - 资源不存在

请求的资源（如饮食计划、任务）不存在。

**常见原因：**
- 饮食计划 ID 不存在
- 任务 ID 不存在
- 用户 ID 不存在

**示例：**
```json
{
  "code": 403,
  "message": "饮食计划不存在",
  "detail": "Plan with id 'xxx' not found"
}
```

### 404 - 资源已存在

尝试创建已存在的资源。

**常见原因：**
- 用户名已被注册
- 邮箱已被注册

**示例：**
```json
// 用户名已存在
{
  "code": 404,
  "message": "用户名已存在",
  "detail": "Username 'user123' is already taken"
}

// 邮箱已被注册
{
  "code": 404,
  "message": "邮箱已被注册",
  "detail": "Email 'user@example.com' is already registered"
}
```

### 409 - 资源已存在（与 404 语义相同）

部分接口使用 409 表示资源冲突，与 404 语义相同。

**相关接口：**
- `POST /api/v1/auth/register`
- `POST /api/v1/auth/verify-register`

### 422 - 验证失败

验证码验证失败，但参数格式正确。

**常见原因：**
- 验证码错误
- 验证码已过期
- 验证码已被使用
- 验证码尝试次数过多

**示例：**
```json
// 验证码错误
{
  "code": 422,
  "message": "验证码错误或已过期",
  "detail": null
}

// 验证码已使用
{
  "code": 422,
  "message": "验证码已被使用",
  "detail": "Verification code has been used"
}

// 验证码尝试次数过多
{
  "code": 422,
  "message": "验证码尝试次数过多",
  "detail": "Too many attempts, please request a new code"
}
```

### 429 - 请求过多（速率限制）

请求频率超出限制。

**相关接口：**
- 验证码发送接口
- 登录接口
- 注册接口

**示例：**
```json
{
  "code": 429,
  "message": "请求过于频繁，请稍后再试",
  "detail": "Too many requests, please try again later"
}
```

### 500 - 服务器内部错误

服务器处理请求时发生未预期的错误。

**示例：**
```json
{
  "code": -1,
  "message": "服务器内部错误",
  "detail": "Internal server error"
}
```

---

## 错误处理最佳实践

### 客户端处理

1. **检查 code 字段**
   - `code === 0`: 请求成功，使用返回的 data
   - `code !== 0`: 请求失败，显示 message

2. **根据错误码显示友好提示**
   ```javascript
   const errorMessages = {
     401: "请重新登录",
     403: "资源不存在，请刷新后重试",
     404: "用户名或邮箱已被注册",
     422: "验证码错误",
     429: "请求过于频繁，请稍后再试",
     500: "服务器繁忙，请稍后再试"
   };
   ```

3. **Token 过期自动刷新**
   - 检测到 401 错误时，尝试使用 Refresh Token
   - 刷新失败后，跳转到登录页面

### 服务端日志

所有错误都应记录日志，包含：
- 请求路径
- 请求参数（脱敏）
- 错误堆栈（开发环境）
- 用户 ID（如已认证）

---

## 常见错误处理模式

### 1. 用户注册

| 场景 | 错误码 | 处理方式 |
|------|---------|----------|
| 用户名已存在 | 404/409 | 提示用户使用其他用户名 |
| 邮箱已注册 | 404/409 | 提示邮箱已被注册 |
| 验证码错误 | 422 | 提示重新输入验证码 |

### 2. 用户登录

| 场景 | 错误码 | 处理方式 |
|------|---------|----------|
| 用户不存在 | 404 | 提示用户名或邮箱错误 |
| 密码错误 | 401 | 提示用户名或密码错误 |
| Token 过期 | 401 | 自动刷新 Token |

### 3. 验证码

| 场景 | 错误码 | 处理方式 |
|------|---------|----------|
| 发送过于频繁 | 429 | 显示冷却倒计时 |
| 验证码错误 | 422 | 清空输入框并重新输入 |
| 验证码已使用 | 422 | 提示请求新的验证码 |

### 4. 饮食计划

| 场景 | 错误码 | 处理方式 |
|------|---------|----------|
| 计划不存在 | 403 | 提示刷新计划列表 |
| 任务不存在 | 403 | 提示刷新任务列表 |
| 任务取消失败 | 403 | 提示任务已结束 |

---

## 国际化

当前所有错误消息使用中文。如需支持多语言，建议：

1. 后端返回错误码
2. 前端根据 code 查找对应语言的消息
3. 使用 JSON 文件管理多语言翻译

---

## 相关文档

- [认证流程说明](AUTH_FLOW.md)
- [API 配置说明](API_CONFIG.md)
- [部署指南](DEPLOYMENT.md)
- [阶段性总结](PHASE_SUMMARY.md)
